<section class="points-page">
  <!-- HEADER MINI -->
  <header class="points-header">
    <div class="title-wrap">
      <div class="icon">üìç</div>
      <div>
        <h1>ƒêi·ªÉm Mua V√© S·ªë</h1>
        <p>T√¨m ƒë·∫°i l√Ω / ƒëi·ªÉm b√°n x·ªï s·ªë &amp; Vietlott g·∫ßn b·∫°n</p>
      </div>
    </div>

    <div class="search-wrap">
      <div class="search-main">
        <input
          type="text"
          [(ngModel)]="keyword"
          (ngModelChange)="onKeywordChange()"
          placeholder="Nh·∫≠p t√™n ƒë·∫°i l√Ω, ƒë∆∞·ªùng, qu·∫≠n, t·ªânh..."
        />

        <select [(ngModel)]="regionFilter" (change)="setRegionFilter(regionFilter)">
          <option value="ALL">T·∫•t c·∫£ v√πng</option>
          <option value="MB">Mi·ªÅn B·∫Øc</option>
          <option value="MN">Mi·ªÅn Nam</option>
          <option value="MT">Mi·ªÅn Trung</option>
        </select>

        <select
          [(ngModel)]="provinceFilter"
          (change)="setProvinceFilter(provinceFilter)">
          <option value="ALL">T·∫•t c·∫£ t·ªânh / TP</option>
          <option *ngFor="let p of provincesOfRegion" [value]="p">
            {{ p }}
          </option>
        </select>
      </div>

      <button
        type="button"
        class="nearby-btn"
        [class.active]="nearbyMode"
        (click)="toggleNearby()">
        <span *ngIf="!loadingGeo; else loading">
          {{ nearbyMode ? 'T·∫Øt ch·∫ø ƒë·ªô g·∫ßn t√¥i' : 'T√¨m ƒëi·ªÉm g·∫ßn t√¥i' }}
        </span>
        <ng-template #loading>ƒêang l·∫•y v·ªã tr√≠‚Ä¶</ng-template>
      </button>

      <p class="geo-error" *ngIf="geoError">{{ geoError }}</p>
    </div>
  </header>

  <!-- MAIN LAYOUT: LIST + MAP -->
  <div class="points-layout">
    <!-- LIST -->
    <section class="points-list">
      <div class="list-head">
        <h2>
          {{ filtered.length }} ƒëi·ªÉm b√°n
          <span *ngIf="nearbyMode && myLocation">‚Ä¢ s·∫Øp x·∫øp theo kho·∫£ng c√°ch</span>
        </h2>
        <p *ngIf="!filtered.length" class="muted">
          Kh√¥ng t√¨m th·∫•y ƒëi·ªÉm b√°n n√†o ph√π h·ª£p b·ªô l·ªçc hi·ªán t·∫°i.
        </p>
      </div>

      <div class="point-card"
           *ngFor="let p of filtered; trackBy: trackById"
           [class.selected]="p === selected"
           (click)="selectPoint(p)">
        <div class="point-main">
          <div class="point-name">{{ p.name }}</div>
          <div class="point-address">
            {{ p.address }}
          </div>
          <div class="point-meta">
            <span class="tag region-tag">
              {{ p.region === 'MB' ? 'Mi·ªÅn B·∫Øc'
              : p.region === 'MN' ? 'Mi·ªÅn Nam'
                : 'Mi·ªÅn Trung' }}
            </span>
            <span class="tag small">{{ p.province }}</span>
            <span class="tag small">{{ p.district }}</span>
            <span
              class="tag distance"
              *ngIf="nearbyMode && p.distanceKm !== undefined">
              ~ {{ p.distanceKm }} km
            </span>
          </div>
          <div class="tags-line" *ngIf="p.tags?.length">
            <span class="chip" *ngFor="let t of p.tags">{{ t }}</span>
          </div>
        </div>

        <div class="point-side">
          <div class="open-time" *ngIf="p.openTime">
            ‚è∞ {{ p.openTime }}
          </div>
          <a
            *ngIf="p.hotline"
            class="call-link"
            [href]="'tel:' + p.hotline">
            ‚òé G·ªçi {{ p.hotline }}
          </a>
          <a
            class="direction-link"
            [href]="buildDirectionsUrl(p)"
            target="_blank"
            rel="noopener">
            ‚ûú Ch·ªâ ƒë∆∞·ªùng
          </a>
        </div>
      </div>
    </section>

    <!-- MAP -->
    <section class="points-map">
      <div class="map-card">
        <div class="map-header">
          <div class="map-title">
            <span>üó∫</span>
            <strong>B·∫£n ƒë·ªì &amp; ch·ªâ ƒë∆∞·ªùng</strong>
          </div>
          <div class="map-desc" *ngIf="selected">
            ƒêang ch·ªçn:
            <span class="map-place">{{ selected.name }}</span>
          </div>
        </div>

        <div class="map-body" *ngIf="mapUrl as mUrl; else noPoint">
          <iframe
            [src]="mUrl"
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
            allowfullscreen
          ></iframe>
        </div>

        <ng-template #noPoint>
          <div class="map-empty">
            Ch·ªçn m·ªôt ƒëi·ªÉm b√°n trong danh s√°ch ƒë·ªÉ xem b·∫£n ƒë·ªì.
          </div>
        </ng-template>
      </div>
    </section>
  </div>
</section>
