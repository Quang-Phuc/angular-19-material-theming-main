<div class="table-wrapper mat-elevation-z4">

  <!-- Progress bar -->
  <mat-progress-bar *ngIf="loading" mode="indeterminate" class="table-progress-bar"></mat-progress-bar>
  <div *ngIf="!loading" class="table-progress-bar-placeholder"></div>

  <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z2 w-full">

    <!-- ==== CỘT DỮ LIỆU ==== -->
    <ng-container *ngFor="let col of columns" [matColumnDef]="col.key">
      <th mat-header-cell *matHeaderCellDef [mat-sort-header]="col.sortable ? col.key : ''">
        {{ col.header }}
      </th>

      <td mat-cell *matCellDef="let row; let i = index" [style.text-align]="col.align || 'start'">
        <!-- Nếu có templateRef thì render bằng ngTemplateOutlet -->
        <ng-container *ngIf="col.templateRef; else defaultCell">
          <ng-container
            *ngTemplateOutlet="col.templateRef; context: { $implicit: row, col: col, index: i }">
          </ng-container>
        </ng-container>

        <!-- Nếu không có templateRef -->
        <ng-template #defaultCell>
          <!-- Nếu là cột 'status' hoặc 'pledgeStatus' thì hiển thị chip màu -->
          <ng-container *ngIf="col.key === 'status' || col.key === 'pledgeStatus'; else normalCell">
      <span class="status-chip" [ngClass]="getStatusClass(row[col.key])">
        <mat-icon class="status-icon" *ngIf="getStatusIcon(row[col.key])">{{ getStatusIcon(row[col.key]) }}</mat-icon>
        {{ getStatusLabel(row[col.key]) }}
      </span>
          </ng-container>

          <ng-template #normalCell>
      <span [ngClass]="{ 'amount-cell': col.type === 'number' }">
        {{ row[col.key] || '' }}
      </span>
          </ng-template>
        </ng-template>
      </td>

    </ng-container>

    <!-- ==== CỘT THAO TÁC (Dropdown Menu) ==== -->
    <ng-container *ngIf="actions?.length" matColumnDef="__actions">
      <th mat-header-cell *matHeaderCellDef style="text-align:center;width:120px">
        Thao tác
      </th>
      <td mat-cell *matCellDef="let row" style="text-align:center">
        <button
          mat-icon-button
          [matMenuTriggerFor]="menu"
          matTooltip="Tùy chọn"
          color="primary">
          <mat-icon>more_vert</mat-icon>
        </button>

        <mat-menu #menu="matMenu">
          <button
            *ngFor="let act of actions"
            mat-menu-item
            (click)="act.handler(row)">
            <mat-icon [color]="act.color || undefined">{{ act.icon || 'more_horiz' }}</mat-icon>
            <span>{{ act.tooltip || 'Hành động' }}</span>
          </button>
        </mat-menu>
      </td>
    </ng-container>

    <!-- ==== Header & Rows ==== -->
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

    <!-- ==== No data ==== -->
    <tr class="mat-row" *matNoDataRow>
      <td class="mat-cell no-data" [attr.colspan]="displayedColumns.length">
        {{ placeholder || 'Không có dữ liệu' }}
      </td>
    </tr>
  </table>

  <!-- ==== Paginator ==== -->
  <mat-paginator
    *ngIf="usePaginator"
    [length]="total"
    [pageSize]="pageSize"
    [pageSizeOptions]="pageSizeOptions"
    (page)="onPage($event)"
    showFirstLastButtons>
  </mat-paginator>
</div>
