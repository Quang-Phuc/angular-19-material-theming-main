<div class="table-wrapper mat-elevation-z4">

  <!-- progress bar khi loading -->
  <mat-progress-bar *ngIf="loading" mode="indeterminate" class="table-progress-bar"></mat-progress-bar>
  <div *ngIf="!loading" class="table-progress-bar-placeholder"></div>

  <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z2 w-full">

    <!-- ==== CỘT DỮ LIỆU CHÍNH ==== -->
    <ng-container *ngFor="let col of columns" [matColumnDef]="col.key">
      <th
        mat-header-cell
        *matHeaderCellDef
        [mat-sort-header]="col.sortable ? col.key : ''"
        [style.text-align]="col.align || 'start'">
        {{ col.header }}
      </th>

      <td
        mat-cell
        *matCellDef="let row; let i = index"
        [style.text-align]="col.align || 'start'">

        <!-- text thường -->
        <ng-container *ngIf="!col.templateRef">
          <span
            [ngClass]="{
              'amount-cell': col.type === 'number',
              'status-chip active': row[col.key] === 'Đang vay',
              'status-chip warning': row[col.key] === 'Quá hạn'
            }">
            {{ row[col.key] || '' }}
          </span>
        </ng-container>

        <!-- custom template -->
        <ng-container *ngIf="col.templateRef">
          <ng-container
            *ngTemplateOutlet="col.templateRef!; context: { $implicit: row, index: i }">
          </ng-container>
        </ng-container>

      </td>
    </ng-container>

    <!-- ==== CỘT THAO TÁC ==== -->
    <ng-container *ngIf="actions?.length" matColumnDef="__actions">
      <th mat-header-cell *matHeaderCellDef style="text-align:center;width:120px">
        Thao tác
      </th>

      <td mat-cell *matCellDef="let row" style="text-align:center">
        <div class="action-buttons">
          <ng-container *ngFor="let act of actions">
            <button
              *ngIf="!act.visible || act.visible(row)"
              mat-icon-button
              [matTooltip]="act.tooltip || ''"
              [color]="act.color || undefined"
              (click)="act.handler(row)">
              <mat-icon>{{ act.icon || 'more_horiz' }}</mat-icon>
            </button>
          </ng-container>
        </div>
      </td>
    </ng-container>

    <!-- ==== DÒNG HEADER + ROW ==== -->
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

    <!-- ==== NO DATA ==== -->
    <tr class="mat-row" *matNoDataRow>
      <td class="mat-cell no-data" [attr.colspan]="displayedColumns.length">
        {{ placeholder || 'Không có dữ liệu' }}
      </td>
    </tr>
  </table>

  <!-- ==== Paginator ==== -->
  <mat-paginator
    *ngIf="usePaginator"
    [length]="total"
    [pageSize]="pageSize"
    [pageSizeOptions]="pageSizeOptions"
    (page)="onPage($event)"
    showFirstLastButtons
    aria-label="Chọn trang">
  </mat-paginator>
</div>
