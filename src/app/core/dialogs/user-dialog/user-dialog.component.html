@if (isLoading) {
  <mat-progress-bar mode="indeterminate" class="dialog-progress-bar"></mat-progress-bar>
}

<h2 mat-dialog-title>{{ isEditMode ? 'Cập nhật Người dùng' : 'Thêm Người dùng mới' }}</h2>

<form [formGroup]="userForm" (ngSubmit)="onSave()">
  <mat-dialog-content class="dialog-content">

    <mat-form-field appearance="outline">
      <mat-label>Họ và tên</mat-label>
      <input matInput formControlName="fullName" cdkFocusInitial>
      @if (userForm.get('fullName')?.hasError('required')) {
        <mat-error>Vui lòng nhập họ tên</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Số điện thoại</mat-label>
      <input matInput formControlName="phone">
      @if (userForm.get('phone')?.hasError('required')) {
        <mat-error>Vui lòng nhập số điện thoại</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Email</mat-label>
      <input matInput formControlName="email" type="email" placeholder="user@example.com">
      @if (userForm.get('email')?.hasError('required')) {
        <mat-error>Vui lòng nhập email</mat-error>
      }
      @if (userForm.get('email')?.hasError('email')) {
        <mat-error>Email không hợp lệ</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>{{ isEditMode ? 'Mật khẩu mới (Bỏ trống nếu không đổi)' : 'Mật khẩu' }}</mat-label>
      <input matInput formControlName="password" type="password">
      @if (userForm.get('password')?.hasError('required')) {
        <mat-error>Vui lòng nhập mật khẩu</mat-error>
      }
      @if (userForm.get('password')?.hasError('minlength')) {
        <mat-error>Mật khẩu phải có ít nhất 6 ký tự</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Chọn tiệm</mat-label>
      <mat-select formControlName="storeId">
        @for (store of storeList; track store.id) {
          <mat-option [value]="store.id">{{ store.name }}</mat-option>
        }
      </mat-select>
      @if (userForm.get('storeId')?.hasError('required')) {
        <mat-error>Vui lòng chọn tiệm</mat-error>
      }
    </mat-form-field>
    @if (isEditMode) {
      <button mat-stroked-button color="warn"
              type="button"
              class="forgot-password-button"
              [disabled]="isSendingReset"
              (click)="onForgotPassword()">
        @if (isSendingReset) {
          <ng-container>
            <mat-icon>sync</mat-icon>
            <span>Đang gửi...</span>
          </ng-container>
        } @else {
          <ng-container>
            <mat-icon>email</mat-icon>
            <span>Gửi link Quên mật khẩu</span>
          </ng-container>
        }
      </button>
    }

  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button type="button" (click)="onCancel()" [disabled]="isLoading">Hủy bỏ</button>
    <button mat-flat-button
            color="primary"
            type="submit"
            [disabled]="userForm.invalid || isLoading">
      Lưu lại
    </button>
  </mat-dialog-actions>
</form>
