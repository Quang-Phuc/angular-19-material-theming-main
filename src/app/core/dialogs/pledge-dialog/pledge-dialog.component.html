<!-- src/app/core/dialogs/pledge-dialog/pledge-dialog.component.html -->

<mat-dialog-content>
  <h2 class="dialog-title">
    {{ isEditMode ? 'Chỉnh sửa Hợp đồng' : 'Thêm mới Hợp đồng' }}
  </h2>

  <!-- === PROGRESS BAR === -->
  <mat-progress-bar *ngIf="isLoading" mode="indeterminate"></mat-progress-bar>
  <div class="progress-bar-placeholder" *ngIf="!isLoading"></div>

  <form [formGroup]="pledgeForm">

    <!-- === 1. THÔNG TIN NGƯỜI VAY (CUSTOMER INFO) === -->
    <fieldset class="content-block customer-info-box" formGroupName="customerInfo">
      <legend>1. Thông tin người vay</legend>

      <div class="customer-main-grid">

        <!-- CỘT 1: ẢNH CHÂN DUNG -->
        <div class="portrait-capture-box">
          <ng-container *ngIf="pledgeForm.get('portraitInfo.imageUrl')?.value; else noImage">
            <img [src]="pledgeForm.get('portraitInfo.imageUrl')?.value" alt="Portrait" class="portrait-preview" />
            <button mat-stroked-button class="capture-btn" (click)="takePicture('portrait')">
              Chụp lại
            </button>
            <button mat-stroked-button class="upload-btn" (click)="takePicture('upload')">
              <mat-icon>cloud_upload</mat-icon> Tải lên khác
            </button>
          </ng-container>
          <ng-template #noImage>
            <mat-icon>camera_alt</mat-icon>
            <span>Chụp ảnh chân dung</span>
            <button mat-stroked-button class="capture-btn" (click)="takePicture('portrait')">
              Chụp
            </button>
            <button mat-stroked-button class="upload-btn" (click)="takePicture('upload')">
              <mat-icon>cloud_upload</mat-icon> Tải lên
            </button>
          </ng-template>
          <!-- Hidden file input for selecting images -->
          <input #fileInput type="file" accept="image/jpeg,image/jpg,image/png" (change)="onFileSelected($event)" style="display: none;" />
        </div>

        <!-- CỘT 2: THÔNG TIN CÁ NHÂN -->
        <div>
          <div class="form-grid-2-col">
            <mat-form-field appearance="outline">
              <mat-label>Họ và tên *</mat-label>
              <input matInput formControlName="hoTen" placeholder="Nguyễn Văn A">
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Số điện thoại *</mat-label>
              <input matInput formControlName="soDienThoai" placeholder="0901234567">
            </mat-form-field>
          </div>

          <div class="form-grid-2-col">
            <mat-form-field appearance="outline">
              <mat-label>Ngày sinh</mat-label>
              <input matInput [matDatepicker]="pickerNgaySinh" formControlName="ngaySinh">
              <mat-datepicker-toggle matIconSuffix [for]="pickerNgaySinh"></mat-datepicker-toggle>
              <mat-datepicker #pickerNgaySinh></mat-datepicker>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Số CCCD/CMND</mat-label>
              <input matInput formControlName="soCCCD" placeholder="123456789">
            </mat-form-field>
          </div>

          <div class="form-grid-2-col">
            <mat-form-field appearance="outline">
              <mat-label>Ngày cấp CCCD</mat-label>
              <input matInput [matDatepicker]="pickerNgayCap" formControlName="ngayCapCCCD">
              <mat-datepicker-toggle matIconSuffix [for]="pickerNgayCap"></mat-datepicker-toggle>
              <mat-datepicker #pickerNgayCap></mat-datepicker>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Nơi cấp CCCD</mat-label>
              <input matInput formControlName="noiCapCCCD" placeholder="Công an TP.HCM">
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Địa chỉ thường trú</mat-label>
            <textarea matInput formControlName="diaChi" rows="2" placeholder="123 Đường ABC, Quận 1, TP.HCM"></textarea>
          </mat-form-field>

          <!-- NÚT TÌM KIẾM KHÁCH HÀNG -->
          <div style="text-align: right; margin-top: 8px;">
            <button mat-stroked-button color="primary" (click)="findCustomer()">
              <mat-icon>search</mat-icon> Tìm khách hàng
            </button>
          </div>
        </div>
      </div>
    </fieldset>

    <!-- === WEBCAM MODAL === -->
    <div class="webcam-modal" *ngIf="showWebcam">
      <div class="webcam-modal-content">
        <h3>Chụp ảnh chân dung</h3>
        <video #videoElement autoplay playsinline class="webcam-video"></video>
        <canvas #canvasElement style="display: none;"></canvas>
        <div class="webcam-actions">
          <button mat-stroked-button (click)="stopWebcam()">Hủy</button>
          <button mat-flat-button color="primary" (click)="capturePhoto()">Chụp</button>
        </div>
      </div>
    </div>

    <!-- === NÚT MỞ THÔNG TIN NÂNG CAO === -->
    <div class="advanced-toggle-wrapper">
      <button mat-stroked-button class="advanced-toggle-btn" (click)="showAdvancedInfo = !showAdvancedInfo">
        <mat-icon>{{ showAdvancedInfo ? 'expand_less' : 'expand_more' }}</mat-icon>
        {{ showAdvancedInfo ? 'Ẩn thông tin nâng cao' : 'Hiện thông tin nâng cao' }}
      </button>
    </div>

    <!-- === THÔNG TIN NÂNG CAO (TAB) === -->
    @if (showAdvancedInfo) {
      <mat-tab-group mat-stretch-tabs="false" animationDuration="300ms" class="sub-tabs content-block">

        <!-- TAB 1: Thông tin khác -->
        <mat-tab label="Thông tin khác">
          <div class="tab-content" formGroupName="customerExtraInfo">
            <div class="form-grid-3-col">
              <mat-form-field appearance="outline"><mat-label>Mã Khách Hàng</mat-label><input matInput formControlName="maKhachHang"></mat-form-field>
              <mat-form-field appearance="outline"><mat-label>Nghề Nghiệp</mat-label><input matInput formControlName="ngheNghiep"></mat-form-field>
              <mat-form-field appearance="outline"><mat-label>Nơi Làm Việc</mat-label><input matInput formControlName="noiLamViec"></mat-form-field>
            </div>
            <div class="form-grid-3-col">
              <mat-form-field appearance="outline"><mat-label>Hộ Khẩu Thường Trú</mat-label><input matInput formControlName="hoKhau"></mat-form-field>
              <mat-form-field appearance="outline"><mat-label>Email</mat-label><input matInput type="email" formControlName="email"></mat-form-field>
              <mat-form-field appearance="outline"><mat-label>Thu Nhập (VNĐ/tháng)</mat-label><input matInput type="number" formControlName="thuNhap"></mat-form-field>
            </div>

            <div class="form-grid-3-col">
              <mat-form-field appearance="outline"><mat-label>Người liên hệ</mat-label><input matInput formControlName="nguoiLienHe"></mat-form-field>
              <mat-form-field appearance="outline"><mat-label>Số điện thoại người liên hệ</mat-label><input matInput formControlName="sdtNguoiLienHe"></mat-form-field>
              <mat-form-field appearance="outline"><mat-label>Ghi Chú</mat-label><textarea matInput formControlName="ghiChu" rows="2"></textarea></mat-form-field>
            </div>
          </div>
        </mat-tab>

        <!-- TAB 2: Thành phần gia đình -->
        <mat-tab label="Thành phần gia đình">
          <div class="tab-content" formGroupName="familyInfo">

            <!-- VỢ/CHỒNG -->
            <fieldset class="family-member">
              <legend>Vợ/Chồng</legend>
              <div class="form-grid-3-col" formGroupName="voChong">
                <mat-form-field appearance="outline"><mat-label>Họ Tên</mat-label><input matInput formControlName="hoTen"></mat-form-field>
                <mat-form-field appearance="outline"><mat-label>Số Điện Thoại</mat-label><input matInput formControlName="soDienThoai"></mat-form-field>
                <mat-form-field appearance="outline"><mat-label>Nghề Nghiệp</mat-label><input matInput formControlName="ngheNghiep"></mat-form-field>
              </div>
            </fieldset>

            <!-- BỐ -->
            <fieldset class="family-member">
              <legend>Bố</legend>
              <div class="form-grid-3-col" formGroupName="bo">
                <mat-form-field appearance="outline"><mat-label>Họ Tên</mat-label><input matInput formControlName="hoTen"></mat-form-field>
                <mat-form-field appearance="outline"><mat-label>Số Điện Thoại</mat-label><input matInput formControlName="soDienThoai"></mat-form-field>
                <mat-form-field appearance="outline"><mat-label>Nghề Nghiệp</mat-label><input matInput formControlName="ngheNghiep"></mat-form-field>
              </div>
            </fieldset>

            <!-- MẸ -->
            <fieldset class="family-member">
              <legend>Mẹ</legend>
              <div class="form-grid-3-col" formGroupName="me">
                <mat-form-field appearance="outline"><mat-label>Họ Tên</mat-label><input matInput formControlName="hoTen"></mat-form-field>
                <mat-form-field appearance="outline"><mat-label>Số Điện Thoại</mat-label><input matInput formControlName="soDienThoai"></mat-form-field>
                <mat-form-field appearance="outline"><mat-label>Nghề Nghiệp</mat-label><input matInput formControlName="ngheNghiep"></mat-form-field>
              </div>
            </fieldset>
          </div>
        </mat-tab>

        <!-- TAB 3: Thông tin cho vay (nâng cao) -->
        <mat-tab label="Thông tin cho vay">
          <div class="tab-content" formGroupName="loanExtraInfo">
            <div class="form-grid-4-col">
              <mat-form-field appearance="outline">
                <mat-label>Tình Trạng</mat-label>
                <mat-select formControlName="tinhTrang">
                  @for (t of (tinhTrangList$ | async); track t) {
                    <mat-option [value]="t">{{ t }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
              <mat-form-field appearance="outline">
                <mat-label>Loại Đối Tác</mat-label>
                <mat-select formControlName="loaiDoiTac">
                  @for (d of (doiTacList$ | async); track d.id) {
                    <mat-option [value]="d.id">{{ d.name }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
              <mat-form-field appearance="outline">
                <mat-label>Người Theo Dõi</mat-label>
                <mat-select formControlName="nguoiTheoDoi">
                  @for (n of (nguoiTheoDoiList$ | async); track n.id) {
                    <mat-option [value]="n.id">{{ n.name }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
              <mat-form-field appearance="outline">
                <mat-label>Nguồn Khách Hàng</mat-label>
                <mat-select formControlName="nguonKhachHang">
                  @for (n of (nguonKhachHangList$ | async); track n.id) {
                    <mat-option [value]="n.id">{{ n.name }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    }

    <!-- === 2. THÔNG TIN CHO VAY (BOLD LEGEND WITH BACKGROUND) === -->
    <fieldset class="form-section content-block loan-info-section" formGroupName="loanInfo">
      <legend>2. Thông tin cho vay</legend>

      <div class="form-grid-3-col">
        <mat-form-field appearance="outline">
          <mat-label>Tên Tài Sản *</mat-label>
          <input matInput formControlName="tenTaiSan" placeholder="Xe Wave RSX">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Loại Tài Sản *</mat-label>
          <input type="text" matInput formControlName="loaiTaiSan" [matAutocomplete]="autoAssetType">
          <mat-autocomplete #autoAssetType="matAutocomplete">
            @for (option of (assetTypes$ | async); track option) {
              <mat-option [value]="option">{{ option }}</mat-option>
            }
          </mat-autocomplete>
        </mat-form-field>

        <!-- Adjusted button to align with Loại Tài Sản field -->
        <button mat-flat-button class="add-asset-type-btn" (click)="addNewAssetType()" matTooltip="Thêm loại tài sản mới" style="margin-top: 20px;">
          <mat-icon>add</mat-icon>
          <span>Thêm mới</span>
        </button>
      </div>

      <div class="form-grid-3-col">
        <mat-form-field appearance="outline">
          <mat-label>Ngày Vay *</mat-label>
          <input matInput [matDatepicker]="pickerNgayVay" formControlName="ngayVay">
          <mat-datepicker-toggle matIconSuffix [for]="pickerNgayVay"></mat-datepicker-toggle>
          <mat-datepicker #pickerNgayVay></mat-datepicker>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Mã Hợp Đồng</mat-label>
          <input matInput formControlName="maHopDong" placeholder="Tự động sinh" [disabled]="isEditMode">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Tổng Tiền Vay *</mat-label>
          <input matInput type="number" formControlName="tongTienVay" placeholder="0">
        </mat-form-field>
      </div>

      <!-- SMART: Kỳ đóng lãi + Lãi suất + Số lần trả + Kiểu thu lãi -->
      <div class="interest-group-grid">
        <div class="interest-item">
          <label class="interest-label">Kỳ Đóng Lãi *</label>
          <div class="input-group">
            <input matInput type="number" formControlName="kyDongLai_So" class="number-input" placeholder="1">
            <mat-select formControlName="kyDongLai_DonVi" class="unit-select">
              <mat-option value="Ngay">Ngày</mat-option>
              <mat-option value="Tuan">Tuần</mat-option>
              <mat-option value="ThangDinhKy">Tháng định kỳ</mat-option>
              <mat-option value="Thang">Tháng</mat-option>
            </mat-select>
          </div>
        </div>

        <div class="interest-item">
          <label class="interest-label">Lãi Suất *</label>
          <div class="input-group">
            <input matInput type="number" formControlName="laiSuat_So" class="number-input" placeholder="0">
            <mat-select formControlName="laiSuat_DonVi" class="unit-select">
              <mat-option value="Lai/Trieu/Ngay">Lãi/Triệu/Ngày</mat-option>
              <mat-option value="Lai%/Thang">Lãi%/Tháng</mat-option>
              <mat-option value="Lai/Ngay">Lãi/Ngày</mat-option>
            </mat-select>
          </div>
        </div>

        <div class="interest-item">
          <label class="interest-label">Số lần trả *</label>
          <div class="input-group">
            <input matInput type="number" formControlName="soLanTra" class="number-input" placeholder="1">
          </div>
        </div>

        <div class="interest-item">
          <label class="interest-label">Kiểu Thu Lãi *</label>
          <div class="input-group">
            <mat-select formControlName="kieuThuLai" class="unit-select">
              <mat-option value="Truoc">Thu trước</mat-option>
              <mat-option value="Sau">Thu sau</mat-option>
            </mat-select>
          </div>
        </div>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Ghi Chú (Hợp đồng)</mat-label>
        <textarea matInput formControlName="ghiChu" rows="2" placeholder="Ghi chú thêm về hợp đồng..."></textarea>
      </mat-form-field>
    </fieldset>

    <mat-accordion multi class="content-block">
      <mat-expansion-panel formGroupName="feesInfo">
        <mat-expansion-panel-header><mat-panel-title>3. Các loại phí</mat-panel-title></mat-expansion-panel-header>
        <div class="fee-grid" formGroupName="phiKho">
          <label>Phí kho</label>
          <mat-radio-group formControlName="type"><mat-radio-button value="NhapTien">Nhập Tiền</mat-radio-button><mat-radio-button value="NhapPhanTram">Nhập %</mat-radio-button></mat-radio-group>
          <mat-form-field appearance="outline"><mat-label>Giá trị</mat-label><input matInput type="number" formControlName="value"></mat-form-field>
        </div>
        <hr>
        <mat-expansion-panel>
          <mat-expansion-panel-header><mat-panel-title>Các loại phí hàng kỳ</mat-panel-title></mat-expansion-panel-header>
          <div class="fee-grid" formGroupName="phiLuuKho"><label>Phí lưu kho</label><mat-radio-group formControlName="type"><mat-radio-button value="NhapTien">Nhập Tiền</mat-radio-button><mat-radio-button value="NhapPhanTram">Nhập %</mat-radio-button></mat-radio-group><mat-form-field appearance="outline"><mat-label>Giá trị</mat-label><input matInput type="number" formControlName="value"></mat-form-field></div>
          <div class="fee-grid" formGroupName="phiRuiRo"><label>Phí rủi ro</label><mat-radio-group formControlName="type"><mat-radio-button value="NhapTien">Nhập Tiền</mat-radio-button><mat-radio-button value="NhapPhanTram">Nhập %</mat-radio-button></mat-radio-group><mat-form-field appearance="outline"><mat-label>Giá trị</mat-label><input matInput type="number" formControlName="value"></mat-form-field></div>
          <div class="fee-grid" formGroupName="phiQuanLi"><label>Phí quản lí</label><mat-radio-group formControlName="type"><mat-radio-button value="NhapTien">Nhập Tiền</mat-radio-button><mat-radio-button value="NhapPhanTram">Nhập %</mat-radio-button></mat-radio-group><mat-form-field appearance="outline"><mat-label>Giá trị</mat-label><input matInput type="number" formControlName="value"></mat-form-field></div>
        </mat-expansion-panel>
      </mat-expansion-panel>

      <!-- 4. Tài sản thế chấp -->
      <mat-expansion-panel formGroupName="collateralInfo">
        <mat-expansion-panel-header><mat-panel-title>4. Thông tin tài sản thế chấp</mat-panel-title></mat-expansion-panel-header>
        <div class="form-grid-4-col">
          <mat-form-field appearance="outline"><mat-label>Định Giá Tài Sản</mat-label><input matInput type="number" formControlName="dinhGia"></mat-form-field>
          <mat-form-field appearance="outline"><mat-label>Biển Kiểm Soát</mat-label><input matInput formControlName="bienKiemSoat"></mat-form-field>
          <mat-form-field appearance="outline"><mat-label>Số Khung</mat-label><input matInput formControlName="soKhung"></mat-form-field>
          <mat-form-field appearance="outline"><mat-label>Số Máy</mat-label><input matInput formControlName="soMay"></mat-form-field>
        </div>
        <div class="form-grid-2-col">
          <mat-form-field appearance="outline">
            <mat-label>Kho</mat-label>
            <mat-select formControlName="kho">
              @for (option of (khoList$ | async); track option.id) {
                <mat-option [value]="option.id">{{option.name}}</mat-option>
              }
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline"><mat-label>Mã Tài Sản</mat-label><input matInput formControlName="maTaiSan"></mat-form-field>
        </div>
        <mat-form-field appearance="outline" class="full-width"><mat-label>Ghi Chú (Tài sản)</mat-label><textarea matInput formControlName="ghiChuTaiSan" rows="2"></textarea></mat-form-field>
      </mat-expansion-panel>

      <!-- 5. Đính kèm -->
      <mat-expansion-panel formGroupName="attachments">
        <mat-expansion-panel-header><mat-panel-title>5. Đính kèm file</mat-panel-title></mat-expansion-panel-header>
        <div class="file-dropzone"
             (dragover)="onDragOver($event)"
             (dragleave)="onDragLeave($event)"
             (drop)="onDrop($event)"
             [class.drag-over]="isDragOver"
             (click)="onAttachmentClick()">
          <mat-icon>cloud_upload</mat-icon>
          <span>Bấm tải ảnh <span style="font-weight: 400; color: #6c757d;">Hoặc kéo thả ảnh tại đây</span></span>
          <div class="dropzone-subtext">JPG, JPEG, PNG, PDF, DOC, DOCX nhỏ hơn 5MB</div>
        </div>

        @if (uploadedFiles.length > 0) {
          <div class="uploaded-files-list">
            <mat-list>
              @for (file of uploadedFiles; track file.name; let i = $index) {
                <mat-list-item>
                  <div matListItemTitle>{{ file.name }}</div>
                  <button mat-icon-button (click)="removeAttachment(i)" matListItemIcon>
                    <mat-icon>delete</mat-icon>
                  </button>
                </mat-list-item>
              }
            </mat-list>
          </div>
        }
      </mat-expansion-panel>
    </mat-accordion>

  </form>
</mat-dialog-content>

<!-- === NÚT HÀNH ĐỘNG === -->
<mat-dialog-actions align="end">
  <button mat-stroked-button class="cancel-button" (click)="onCancel()" [disabled]="isLoading">
    Hủy
  </button>
  <button mat-flat-button class="save-button" (click)="onSave()" [disabled]="isLoading || pledgeForm.invalid">
    <mat-icon>save</mat-icon>
    {{ isEditMode ? 'Cập nhật' : 'Lưu' }}
  </button>
</mat-dialog-actions>
