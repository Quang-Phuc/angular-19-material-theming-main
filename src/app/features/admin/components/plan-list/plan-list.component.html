<div class="page-container">

  <!-- HEADER -->
  <div class="page-header">
    <h1>Quản lý Gói License (Plans)</h1>
    <button mat-flat-button color="primary" (click)="openPlanDialog()">
      <mat-icon>add</mat-icon>
      Thêm Gói mới
    </button>
  </div>

  <!-- KHUNG TÌM KIẾM -->
  <mat-card class="search-card">
    <form [formGroup]="searchForm" (ngSubmit)="onAdvancedSearch()">

      <div class="search-container">
        <mat-form-field appearance="outline" class="search-basic-field">
          <mat-label>Tìm theo Tên hoặc Mã gói...</mat-label>
          <input matInput formControlName="basicSearch" (input)="applyBasicSearch($event)">
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>
        <button mat-button type="button" (click)="showAdvancedSearch = !showAdvancedSearch" class="advanced-toggle">
          Tìm kiếm nâng cao
          <mat-icon>{{ showAdvancedSearch ? 'expand_less' : 'expand_more' }}</mat-icon>
        </button>
      </div>

      <!-- TÌM KIẾM NÂNG CAO -->
      @if (showAdvancedSearch) {
        <div class="advanced-search-panel">
          <!-- Lọc theo Trạng thái -->
          <mat-form-field appearance="outline">
            <mat-label>Trạng thái</mat-label>
            <mat-select formControlName="status">
              <mat-option [value]="null">Tất cả</mat-option>
              <mat-option value="active">Đang hoạt động</mat-option>
              <mat-option value="inactive">Ngừng cung cấp</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Lọc theo Nổi bật -->
          <mat-form-field appearance="outline">
            <mat-label>Loại gói</mat-label>
            <mat-select formControlName="isHighlighted">
              <mat-option [value]="null">Tất cả</mat-option>
              <mat-option [value]="true">Gói nổi bật</mat-option>
              <mat-option [value]="false">Gói thường</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Nút bấm lọc -->
          <div class="search-actions">
            <button mat-stroked-button type="button" (click)="resetSearch()">Reset</button>
            <button mat-flat-button color="primary" type="submit">Tìm kiếm</button>
          </div>
        </div>
      }
    </form>
  </mat-card>

  <!-- BẢNG DỮ LIỆU -->
  <div class="table-container mat-elevation-z4">

    @if (isLoading) {
      <div class="loading-shade">
        <mat-spinner></mat-spinner>
      </div>
    }

    <table mat-table [dataSource]="dataSource" matSort>

      <!-- Cột Tên Gói -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Tên Gói</th>
        <td mat-cell *matCellDef="let plan" class="cell-name">{{ plan.name }}</td>
      </ng-container>

      <!-- Cột Mã Gói -->
      <ng-container matColumnDef="code">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Mã Gói</th>
        <td mat-cell *matCellDef="let plan" class="cell-code">{{ plan.code }}</td>
      </ng-container>

      <!-- Cột Giá / tháng -->
      <ng-container matColumnDef="priceMonth">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Giá / tháng</th>
        <td mat-cell *matCellDef="let plan">
          {{ plan.priceMonth > 0 ? (plan.priceMonth | number:'1.0-0':'vi-VN') + ' VND' : 'Miễn phí' }}
        </td>
      </ng-container>

      <!-- Cột Chi nhánh -->
      <ng-container matColumnDef="maxBranches">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Chi nhánh</th>
        <td mat-cell *matCellDef="let plan" class="cell-limit">
          {{ plan.maxBranches >= 999 ? 'Không giới hạn' : plan.maxBranches }}
        </td>
      </ng-container>

      <!-- Cột Users -->
      <ng-container matColumnDef="maxUsers">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Users</th>
        <td mat-cell *matCellDef="let plan" class="cell-limit">
          {{ plan.maxUsers >= 999 ? 'Không giới hạn' : plan.maxUsers }}
        </td>
      </ng-container>

      <!-- Cột Trạng thái -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Trạng thái</th>
        <td mat-cell *matCellDef="let plan">
          <span class="status-pill" [ngClass]="'status-' + plan.status">
            {{ plan.status === 'active' ? 'Đang hoạt động' : 'Ngừng cung cấp' }}
          </span>
        </td>
      </ng-container>

      <!-- Cột Nổi bật -->
      <ng-container matColumnDef="isHighlighted">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Nổi bật</th>
        <td mat-cell *matCellDef="let plan" class="cell-center">
          @if (plan.isHighlighted) {
            <mat-icon color="primary" matTooltip="Gói này được đánh dấu nổi bật">star</mat-icon>
          } @else {
            <mat-icon class="icon-muted">star_border</mat-icon>
          }
        </td>
      </ng-container>

      <!-- Cột Hành động -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Hành động</th>
        <td mat-cell *matCellDef="let plan" class="action-buttons">
          <button mat-icon-button color="primary" (click)="openPlanDialog(plan)" matTooltip="Sửa thông tin gói">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="warn" (click)="onDeletePlan(plan.id, plan.name)" matTooltip="Xóa gói này">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      <!-- Hàng Không có dữ liệu -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          @if (isLoading) {
            <span>Đang tải dữ liệu...</span>
          } @else {
            <span>Không tìm thấy gói nào khớp với tìm kiếm.</span>
          }
        </td>
      </tr>
    </table>

    <!-- PHÂN TRANG -->
    <mat-paginator [length]="resultsLength"
                   [pageSize]="10"
                   [pageSizeOptions]="[10, 25, 50, 100]"
                   showFirstLastButtons
                   aria-label="Chọn trang">
    </mat-paginator>
  </div>
</div>
