<div class="page-container">

  <div class="page-header">
    <h1>Quản lý Tiệm</h1>
    <button mat-flat-button color="primary" (click)="openStoreDialog()">
      <mat-icon>add</mat-icon>
      Thêm Tiệm mới
    </button>
  </div>

  <mat-card class="search-card">
    <form [formGroup]="searchForm" (ngSubmit)="onAdvancedSearch()">

      <div class="search-container">
        <mat-form-field appearance="outline" class="search-basic-field">
          <mat-label>Tìm tên, SĐT, chủ tiệm...</mat-label>
          <input matInput formControlName="basicSearch" (input)="applyBasicSearch($event)">
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>
        <button mat-button type="button" (click)="showAdvancedSearch = !showAdvancedSearch" class="advanced-toggle">
          Tìm kiếm nâng cao
          <mat-icon>{{ showAdvancedSearch ? 'expand_less' : 'expand_more' }}</mat-icon>
        </button>
      </div>

      @if (showAdvancedSearch) {
        <div class="advanced-search-panel" data-aos="fade-in">
          <mat-form-field appearance="outline">
            <mat-label>Trạng thái</mat-label>
            <mat-select formControlName="status">
              <mat-option [value]="null">Tất cả</mat-option>
              <mat-option value="active">Đang hoạt động</mat-option>
              <mat-option value="trial">Dùng thử</mat-option>
              <mat-option value="expired">Hết hạn</mat-option>
              <mat-option value="locked">Bị khóa</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Gói License</mat-label>
            <mat-select formControlName="plan">
              <mat-option [value]="null">Tất cả</mat-option>
              <mat-option value="Standard">Standard</mat-option>
              <mat-option value="Pro">Pro</mat-option>
            </mat-select>
          </mat-form-field>

          <div class="search-actions">
            <button mat-stroked-button type="button" (click)="resetSearch()">Reset</button>
            <button mat-flat-button color="primary" type="submit">Tìm kiếm</button>
          </div>
        </div>
      }
    </form>
  </mat-card>

  <div class="table-container mat-elevation-z4">

    @if (isLoading) {
      <div class="loading-shade">
        <mat-spinner></mat-spinner>
      </div>
    }

    <table mat-table [dataSource]="dataSource" matSort>

      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Tên Tiệm</th>
        <td mat-cell *matCellDef="let store">{{ store.storeName }}</td>
      </ng-container>

      <ng-container matColumnDef="ownerName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Chủ Tiệm</th>
        <td mat-cell *matCellDef="let store">{{ store.userFullName }}</td>
      </ng-container>

      <ng-container matColumnDef="phone">
        <th mat-header-cell *matHeaderCellDef>Số điện thoại</th>
        <td mat-cell *matCellDef="let store">{{ store.userPhone }}</td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Trạng thái</th>
        <td mat-cell *matCellDef="let store">
          <span class="status-pill" [ngClass]="'status-' + (store.status | lowercase)">
            {{ store.status === 'active' ? 'Đang hoạt động' :
            store.status === 'trial' ? 'Dùng thử' :
              store.status === 'expired' ? 'Hết hạn' : 'Bị khóa' }}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="licensePlan">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Gói</th>
        <td mat-cell *matCellDef="let store">{{ store.licensePlan }}</td>
      </ng-container>

      <ng-container matColumnDef="expiryDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Ngày Hết Hạn</th>
        <td mat-cell *matCellDef="let store">{{ store.expiryDate | date: 'dd/MM/yyyy' }}</td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Hành động</th>
        <td mat-cell *matCellDef="let store" class="action-buttons">
          <button mat-icon-button color="primary" (click)="openStoreDialog(store)" matTooltip="Sửa">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="warn" (click)="onDeleteStore(store.id, store.name)" matTooltip="Xóa">
            <mat-icon>delete</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" colspan="7">
          @if (isLoading) {
            <span>Đang tải dữ liệu...</span>
          } @else {
            <span>Không tìm thấy dữ liệu khớp với tìm kiếm.</span>
          }
        </td>
      </tr>
    </table>

    <mat-paginator [length]="resultsLength"
                   [pageSize]="10"
                   [pageSizeOptions]="[10, 25, 50, 100]"
                   showFirstLastButtons
                   aria-label="Chọn trang">
    </mat-paginator>
  </div>
</div>
