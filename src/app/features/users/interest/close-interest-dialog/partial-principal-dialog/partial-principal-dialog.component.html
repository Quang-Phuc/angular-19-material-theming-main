<h2 mat-dialog-title class="title">
  <mat-icon color="primary" class="title-icon">account_balance_wallet</mat-icon>
  Trả bớt gốc – Hợp đồng: <strong>{{ data.detail.contractCode || 'CĐ251411-002' }}</strong>
</h2>

<mat-dialog-content class="content">

  <!-- 1. THÔNG TIN HỢP ĐỒNG -->
  <div class="section">
    <h3 class="section-title">
      <mat-icon class="section-icon">description</mat-icon>
      Thông tin hợp đồng
    </h3>
    <div class="grid">
      <div class="info-item">
        <span class="label">Tên khách hàng</span>
        <strong class="value">{{ data.detail.customerName || 'Abc 123 000' }}</strong>
      </div>
      <div class="info-item">
        <span class="label">Số tiền vay</span>
        <strong class="value primary">{{ formatMoney(data.detail.loanAmount) }}</strong>
      </div>
      <div class="info-item">
        <span class="label">Ngày vay</span>
        <strong class="value">{{ formatDate(data.detail.loanDate) }}</strong>
      </div>
      <div class="info-item">
        <span class="label">Lãi suất hiện tại</span>
        <strong class="value warning">
          {{ data.detail.currentInterestRate }} {{ data.detail.interestRateUnit === 'PER_MILLION' ? 'đ/triệu/ngày' : '‰/ngày' }}
        </strong>
      </div>
    </div>
  </div>

  <!-- 2. TÌNH TRẠNG HIỆN TẠI -->
  <div class="section">
    <h3 class="section-title">
      <mat-icon class="section-icon">calculator</mat-icon>
      Tình trạng hiện tại
    </h3>
    <div class="summary-grid">
      <div class="summary-item">
        <span>Gốc còn lại</span>
        <b class="big">{{ formatMoney(data.detail.remainingPrincipal) }}</b>
      </div>
      <div class="summary-item">
        <span>Tổng lãi đến nay</span>
        <b class="big">{{ formatMoney(data.detail.remainingPrincipal) }}</b>
      </div>
      <div class="summary-item">
        <span>Phạt quá hạn</span>
        <b class="big text-danger">{{ formatMoney(data.detail.penaltyInterest) }}</b>
      </div>
      <div class="summary-item">
        <span class="text-danger font-bold">Tổng còn nợ</span>
        <b class="big text-danger font-bold">{{ formatMoney(data.detail.remainingAmount) }}</b>
      </div>
    </div>
  </div>

  <!-- 3. NỘI DUNG TRẢ BỚT GỐC -->
  <div class="section">
    <h3 class="section-title">
      <mat-icon class="section-icon">receipt_long</mat-icon>
      Nội dung trả bớt gốc
    </h3>

    <form [formGroup]="form" class="form">

      <div class="form-row">
        <mat-form-field appearance="outline" class="w-50">
          <mat-label>Tên khách hàng</mat-label>
          <input matInput formControlName="payerName" [value]="data.detail.customerName" readonly>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-50">
          <mat-label>Ngày trả gốc</mat-label>
          <input matInput [matDatepicker]="datePicker" formControlName="payDate" required>
          <mat-datepicker-toggle matIconSuffix [for]="datePicker"></mat-datepicker-toggle>
          <mat-datepicker #datePicker></mat-datepicker>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="full">
        <mat-label>Tiền trả bớt gốc</mat-label>
        <input matInput type="text" appCurrencyFormat formControlName="amount" required>
        <span matTextSuffix>đ</span>
        <mat-hint align="end">
<!--          <span [class]="getAmountStatusClass()">-->
<!--            {{ getAmountStatusText() }}-->
<!--          </span>-->
        </mat-hint>
        <mat-error *ngIf="getAmountStatus() === 'exceed'">
          Không được vượt quá gốc còn lại
        </mat-error>
      </mat-form-field>

      <div class="form-row">
        <mat-form-field appearance="outline" class="w-50">
          <mat-label>Lãi suất cũ</mat-label>
          <input matInput [value]="data.detail.currentInterestRate + (data.detail.interestRateUnit === 'PER_MILLION' ? ' đ/triệu/ngày' : ' ‰/ngày')" readonly>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-50">
          <mat-label>Lãi suất mới (sau trả bớt)</mat-label>
          <input matInput type="text" formControlName="newRate" placeholder="VD: 1.8">
          <span matTextSuffix>‰/ngày</span>
          <mat-hint>Nếu không đổi, để trống</mat-hint>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="full">
        <mat-label>Phí khác (nếu có)</mat-label>
        <input matInput type="text" appCurrencyFormat formControlName="otherFee">
        <span matTextSuffix>đ</span>
      </mat-form-field>

      <!-- TỔNG TIỀN KHÁCH NỘP -->
      <div class="total-box">
        <div class="total-label">TỔNG TIỀN KHÁCH NỘP</div>
        <div class="total-amount" [class.success]="getDiff() >= 0">
          {{ formatMoney(getTotalPaid()) }}
        </div>
        <div class="total-note" [class]="getDiffClass()">
          {{ getDiffText() }}
        </div>
      </div>

      <mat-form-field appearance="outline" class="full">
        <mat-label>Ghi chú</mat-label>
        <textarea matInput rows="3" formControlName="note"
                  placeholder="VD: Khách trả bớt 5 triệu, giảm lãi suất từ 2‰ xuống 1.8‰"></textarea>
      </mat-form-field>

    </form>
  </div>

  <!-- 4. LỊCH SỬ TRẢ BỚT GỐC -->
  <div class="section" *ngIf="data.detail.principalReductionHistory?.length">
    <h3 class="section-title">
      <mat-icon class="section-icon">history</mat-icon>
      Lịch sử trả bớt gốc ({{ data.detail.principalReductionHistory.length }} lần)
    </h3>

    <table mat-table [dataSource]="data.detail.principalReductionHistory" class="history-table mat-elevation-z2">

      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef> Ngày </th>
        <td mat-cell *matCellDef="let h"> {{ h.date | date:'dd/MM/yyyy' }} </td>
      </ng-container>

      <ng-container matColumnDef="amount">
        <th mat-header-cell *matHeaderCellDef> Trả bớt </th>
        <td mat-cell *matCellDef="let h">
          <strong class="text-primary">{{ formatMoney(h.amount) }}</strong>
        </td>
      </ng-container>

      <ng-container matColumnDef="rate">
        <th mat-header-cell *matHeaderCellDef> Lãi suất </th>
        <td mat-cell *matCellDef="let h">
          <span [class.text-success]="h.newInterestRate">
            {{ h.oldInterestRate }}
            <mat-icon *ngIf="h.newInterestRate" class="small-icon">arrow_forward</mat-icon>
            {{ h.newInterestRate || h.oldInterestRate }}
            {{ h.interestRateUnit === 'PER_MILLION' ? 'đ/triệu/ngày' : '‰/ngày' }}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="fee">
        <th mat-header-cell *matHeaderCellDef> Phí khác </th>
        <td mat-cell *matCellDef="let h"> {{ formatMoney(h.otherFee) }} </td>
      </ng-container>

      <ng-container matColumnDef="total">
        <th mat-header-cell *matHeaderCellDef> Tổng nộp </th>
        <td mat-cell *matCellDef="let h">
          <b class="text-danger">{{ formatMoney(h.totalPaidThisTime) }}</b>
        </td>
      </ng-container>

      <ng-container matColumnDef="by">
        <th mat-header-cell *matHeaderCellDef> Nhân viên </th>
        <td mat-cell *matCellDef="let h"> {{ h.createdBy }} </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
  </div>

</mat-dialog-content>

<mat-dialog-actions align="end" class="actions">
  <button mat-stroked-button color="warn" mat-dialog-close>
    <mat-icon>close</mat-icon> Hủy
  </button>
  <button mat-flat-button color="primary" class="confirm-btn"
          [disabled]="form.invalid || getAmountStatus() !== 'valid'"
          (click)="confirm()">
    <mat-icon>check_circle</mat-icon>
    Xác nhận trả bớt gốc
  </button>
</mat-dialog-actions>
