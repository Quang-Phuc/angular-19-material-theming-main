<div class="dialog-container" [@fadeIn]>

  <!-- HEADER GRADIENT -->
  <div class="header-gradient">
    <div class="header-content">
      <div class="title-group">
        <div class="icon-circle">
          <mat-icon>request_quote</mat-icon>
        </div>
        <div class="title-text">
          <h2>Đóng lãi / Quản lý hợp đồng</h2>
          <p class="contract-id">HĐ: {{ pledge?.contractCode || '...' }}</p>
        </div>
      </div>

      <div class="header-actions">
        <button mat-raised-button color="primary" class="action-btn" (click)="openSettleDialog()">
          <mat-icon>done_all</mat-icon>
          Tất toán
        </button>
        <button mat-raised-button color="accent" class="action-btn" (click)="openExtendTermDialog()">
          <mat-icon>update</mat-icon>
          Gia hạn
        </button>
        <button mat-raised-button color="warn" class="action-btn" (click)="openPartialPrincipalDialog()">
          <mat-icon>money_off</mat-icon>
          Trả bớt
        </button>
        <button mat-raised-button class="action-btn add-loan" (click)="openAdditionalLoanDialog()">
          <mat-icon>add_card</mat-icon>
          Vay thêm
        </button>

        <div class="export-group">
          <button mat-icon-button matTooltip="PDF" (click)="exportFile('pdf')" class="export-btn">
            <mat-icon>picture_as_pdf</mat-icon>
          </button>
          <button mat-icon-button matTooltip="Excel" (click)="exportFile('excel')" class="export-btn">
            <mat-icon>grid_on</mat-icon>
          </button>
          <button mat-icon-button matTooltip="Đóng" (click)="close()" class="close-btn">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- PROGRESS BAR -->
  <mat-progress-bar *ngIf="loadingSummary" mode="indeterminate" class="progress-thin"></mat-progress-bar>

  <!-- SUMMARY CARDS -->
  <div class="summary-cards" *ngIf="pledge">
    <div class="summary-card glass">
      <div class="card-icon">
        <mat-icon>person</mat-icon>
      </div>
      <div class="card-label">Khách hàng</div>
      <div class="card-value">{{ pledge.customer.fullName }}</div>
      <div class="card-sub">{{ pledge.customer.phoneNumber }}</div>
    </div>

    <!-- <div class="summary-card glass highlight">
      <div class="card-icon"><mat-icon>savings</mat-icon></div>
      <div class="card-label">Gốc còn lại</div>
      <div class="card-value">{{ summary.remainingPrincipal | number:'1.0-0' }} đ</div>
    </div>

    <div class="summary-card glass warn">
      <div class="card-icon"><mat-icon>currency_exchange</mat-icon></div>
      <div class="card-label">Lãi hôm nay</div>
      <div class="card-value">{{ summary.interestToday | number:'1.0-0' }} đ</div>
    </div> -->
  </div>

  <!-- TAB GROUP -->
  <mat-tab-group
    [selectedIndex]="activeTab"
    (selectedIndexChange)="activeTab = $event"
    class="custom-tab-group"
    animationDuration="300ms">

    <!-- TAB 1: Chi tiết đóng lãi -->
    <mat-tab label="Chi tiết đóng lãi">
      <div class="tab-content">
        <app-smart-table
          #table
          [columns]="columns"
          [fetch]="fetch"
          [actions]="rowActions"
          [pageSizeOptions]="[10,25,50]"
          [initialPageSize]="10"
          placeholder="Không có kỳ đóng lãi"
          class="modern-table">

          <!-- Templates giữ nguyên -->
          <ng-template #sttTpl let-index="index">{{ index + 1 }}</ng-template>
          <ng-template #dateTpl let-row>{{ row.dueDate | date:'dd/MM/yyyy' }}</ng-template>
          <ng-template #moneyTpl let-row let-col="col">
            <span class="money-cell">{{ formatMoney(row[col.key]) }}</span>
          </ng-template>
          <ng-template #totalTpl let-row>
            <div class="multi-payments">
              <div *ngIf="row.transactions?.length === 0">—</div>

              <div class="payment-line" *ngFor="let t of row.transactions">
                <span class="amount">{{ formatMoney(t.amount) }}</span>
                <small class="date">({{ t.paymentDate | date:'dd/MM/yyyy' }})</small>
              </div>
            </div>
          </ng-template>
          <ng-template #statusTpl let-row>
            <div class="status-badge"
                 [class.paid]="row.status === 'PAID'"
                 [class.partial]="row.status === 'PARTIAL'"
                 [class.pending]="row.status !== 'PAID' && row.status !== 'PARTIAL' && !isOverdue(row)"
                 [class.overdue]="row.status !== 'PAID' && row.status !== 'PARTIAL' && isOverdue(row)">

              <!-- ICON -->
              <mat-icon class="status-icon">
                {{ getStatusIcon(row) }}
              </mat-icon>

              <!-- TEXT -->
              <span class="status-text">{{ getStatusText(row) }}</span>
              <small class="days-left" *ngIf="getDaysLeft(row)">({{ getDaysLeft(row) }})</small>
            </div>
          </ng-template>
        </app-smart-table>
      </div>
    </mat-tab>

    <!-- TAB 2: Thông tin hợp đồng -->
    <mat-tab label="Thông tin hợp đồng">
      <div class="contract-tab-dashboard" *ngIf="pledge">

        <!-- 1. KHÁCH HÀNG -->
        <div class="contract-tab-block">
          <div class="contract-tab-header">
            <mat-icon class="header-icon">person</mat-icon>
            <h3>Thông tin khách hàng</h3>
          </div>
          <div class="contract-tab-content">
            <div class="contract-tab-customer-row">
              <div class="contract-tab-avatar">
                <mat-icon>account_circle</mat-icon>
              </div>
              <div class="contract-tab-customer-details">
                <div class="name">{{ pledge.customer.fullName }}</div>
                <div class="info-line">
                  <mat-icon fontSet="material-icons-outlined">credit_card</mat-icon>
                  <span>CCCD: {{ pledge.customer.identityNumber || 'Chưa cập nhật' }}</span>
                </div>
                <div class="info-line">
                  <mat-icon fontSet="material-icons-outlined">phone</mat-icon>
                  <span>SĐT: {{ pledge.customer.phoneNumber }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 2. TÀI SẢN -->
        <div class="contract-tab-block">
          <div class="contract-tab-header">
            <mat-icon class="header-icon">directions_car</mat-icon>
            <h3>Thông tin tài sản</h3>
          </div>
          <div class="contract-tab-content">
            <div class="contract-tab-asset-row">
              <div class="contract-tab-thumbnail">
                <div class="placeholder-img">
                  <mat-icon>image</mat-icon>
                </div>
              </div>
              <div class="contract-tab-asset-details">
                <div class="asset-name">10000000</div>
                <div class="info-line">
                  <mat-icon fontSet="material-icons-outlined">confirmation_number</mat-icon>
                  <span>Biển số: 10000000</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 3. VAY -->
        <div class="contract-tab-block">
          <div class="contract-tab-header">
            <mat-icon class="header-icon">monetization_on</mat-icon>
            <h3>Thông tin vay</h3>
          </div>
          <div class="contract-tab-content">
            <div class="contract-tab-loan-grid">
              <div class="contract-tab-loan-item">
                <div class="label">Số tiền vay</div>
                <div class="value highlight">10000000</div>
              </div>
              <div class="contract-tab-loan-item">
                <div class="label">Lãi suất</div>
                <div class="value">10000000 đ/triệu/ngày</div>
              </div>
              <div class="contract-tab-loan-item">
                <div class="label">Kỳ hạn</div>
                <div class="value">10000000 ngày/kỳ</div>
              </div>
              <div class="contract-tab-loan-item">
                <div class="label">Lãi mỗi kỳ</div>
                <div class="value success">10000000</div>
              </div>
              <div class="contract-tab-loan-item">
                <div class="label">Tổng kỳ</div>
                <div class="value">10000000 kỳ</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 4. THANH TOÁN -->
        <div class="contract-tab-block">
          <div class="contract-tab-header">
            <mat-icon class="header-icon">receipt_long</mat-icon>
            <h3>Tình trạng thanh toán</h3>
          </div>
          <div class="contract-tab-content">
            <div class="contract-tab-payment-summary">
              <div class="contract-tab-summary-item">
                <div class="label">Đã thanh toán</div>
                <div class="value success">{{ formatMoney(summary?.totalPaid || 10400000) }}</div>
              </div>
              <div class="contract-tab-summary-item">
                <div class="label">Còn lại</div>
                <div class="value warn">{{ formatMoney(summary?.remainingAmount || 3600000) }}</div>
              </div>
            </div>

            <div class="contract-tab-progress-section">
              <div class="progress-label">
                <span>Kỳ đã đóng: 10000000</span>
                <span class="current-term">Kỳ hiện tại: 10000000</span>
              </div>
              <mat-progress-bar
                mode="determinate"
                [value]="10000000"
                class="contract-tab-progress">
              </mat-progress-bar>
            </div>
          </div>
        </div>

        <!-- FOOTER -->
        <div class="contract-tab-footer">
          <button mat-stroked-button class="contract-tab-btn">
            <mat-icon>history</mat-icon>
            Xem lịch sử đóng lãi
          </button>
          <button mat-stroked-button class="contract-tab-btn">
            <mat-icon>print</mat-icon>
            In hợp đồng
          </button>
          <button mat-flat-button color="primary" class="contract-tab-btn primary">
            <mat-icon>payments</mat-icon>
            Đóng lãi kỳ hiện tại
          </button>
        </div>
      </div>
    </mat-tab>

    <!-- TAB 3 & 4: Coming soon -->
    <mat-tab label="Lịch sử đóng lãi">
      <div class="tab-content placeholder">Đang phát triển...</div>
    </mat-tab>
    <mat-tab label="Lịch sử thu phí">
      <div class="tab-content placeholder">Đang phát triển...</div>
    </mat-tab>
  </mat-tab-group>
</div>
