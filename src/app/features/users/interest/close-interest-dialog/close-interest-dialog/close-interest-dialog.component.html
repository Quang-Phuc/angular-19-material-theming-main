<div class="dialog-container" [@fadeIn]>

  <!-- HEADER GRADIENT -->
  <div class="header-gradient">
    <div class="header-content">
      <div class="title-group">
        <div class="icon-circle">
          <mat-icon>request_quote</mat-icon>
        </div>
        <div class="title-text">
          <h2>Đóng lãi / Quản lý hợp đồng</h2>
          <p class="contract-id">HĐ: {{ pledge?.contractCode || '...' }}</p>
        </div>
      </div>

      <div class="header-actions">
        <button mat-raised-button color="primary" class="action-btn" (click)="openSettleDialog()">
          <mat-icon>done_all</mat-icon> Tất toán
        </button>
        <button mat-raised-button color="accent" class="action-btn" (click)="openExtendTermDialog()">
          <mat-icon>update</mat-icon> Gia hạn
        </button>
        <button mat-raised-button color="warn" class="action-btn" (click)="openPartialPrincipalDialog()">
          <mat-icon>money_off</mat-icon> Trả bớt
        </button>
        <button mat-raised-button class="action-btn add-loan" (click)="openAdditionalLoanDialog()">
          <mat-icon>add_card</mat-icon> Vay thêm
        </button>

        <div class="export-group">
          <button mat-icon-button matTooltip="PDF" (click)="exportFile('pdf')" class="export-btn">
            <mat-icon>picture_as_pdf</mat-icon>
          </button>
          <button mat-icon-button matTooltip="Excel" (click)="exportFile('excel')" class="export-btn">
            <mat-icon>grid_on</mat-icon>
          </button>
          <button mat-icon-button matTooltip="Đóng" (click)="close()" class="close-btn">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- PROGRESS BAR -->
  <mat-progress-bar *ngIf="loadingSummary" mode="indeterminate" class="progress-thin"></mat-progress-bar>

  <!-- SUMMARY CARDS -->
  <div class="summary-cards" *ngIf="pledge">
    <div class="summary-card glass">
      <div class="card-icon"><mat-icon>person</mat-icon></div>
      <div class="card-label">Khách hàng</div>
      <div class="card-value">{{ pledge.customer.fullName }}</div>
      <div class="card-sub">{{ pledge.customer.phoneNumber }}</div>
    </div>

    <!-- <div class="summary-card glass highlight">
      <div class="card-icon"><mat-icon>savings</mat-icon></div>
      <div class="card-label">Gốc còn lại</div>
      <div class="card-value">{{ summary.remainingPrincipal | number:'1.0-0' }} đ</div>
    </div>

    <div class="summary-card glass warn">
      <div class="card-icon"><mat-icon>currency_exchange</mat-icon></div>
      <div class="card-label">Lãi hôm nay</div>
      <div class="card-value">{{ summary.interestToday | number:'1.0-0' }} đ</div>
    </div> -->
  </div>

  <!-- TAB GROUP -->
  <mat-tab-group
    [selectedIndex]="activeTab"
    (selectedIndexChange)="activeTab = $event"
    class="custom-tab-group"
    animationDuration="300ms">

    <!-- TAB 1: Chi tiết đóng lãi -->
    <mat-tab label="Chi tiết đóng lãi">
      <div class="tab-content">
        <app-smart-table
          #table
          [columns]="columns"
          [fetch]="fetch"
          [actions]="rowActions"
          [pageSizeOptions]="[10,25,50]"
          [initialPageSize]="10"
          placeholder="Không có kỳ đóng lãi"
          class="modern-table">

          <!-- Templates giữ nguyên -->
          <ng-template #sttTpl let-index="index">{{ index + 1 }}</ng-template>
          <ng-template #dateTpl let-row>{{ row.dueDate | date:'dd/MM/yyyy' }}</ng-template>
          <ng-template #moneyTpl let-row let-col="col">
            <span class="money-cell">{{ formatMoney(row[col.key]) }}</span>
          </ng-template>
          <ng-template #totalTpl let-row>
            <div class="paid-wrapper" [class.paid]="row.status === 'PAID'" [class.pending]="row.status !== 'PAID'">
              <span class="amount">{{ formatMoney(row.paidAmount) }}</span>
              <small *ngIf="row.paidDate" class="date">({{ row.paidDate | date:'dd/MM' }})</small>
            </div>
          </ng-template>
          <ng-template #statusTpl let-row>
            <div class="status-badge" [class.done]="row.status === 'PAID'" [class.pending]="row.status !== 'PAID'">
              <mat-icon>{{ row.status === 'PAID' ? 'check_circle' : 'schedule' }}</mat-icon>
              <span>{{ row.status === 'PAID' ? 'Đã đóng' : 'Chưa đóng' }}</span>
            </div>
          </ng-template>
        </app-smart-table>
      </div>
    </mat-tab>

    <!-- TAB 2: Thông tin hợp đồng -->
    <mat-tab label="Thông tin hợp đồng">
      <div class="tab-content info-grid" *ngIf="pledge">
        <div class="info-item"><span>Ngày vay</span><b>{{ pledge.loan.loanDate | date:'dd/MM/yyyy' }}</b></div>
        <div class="info-item"><span>Mã HĐ</span><b>{{ pledge.contractCode }}</b></div>
        <div class="info-item"><span>Người theo dõi</span><b>{{ pledge.loan.follower || '-' }}</b></div>
        <div class="info-item"><span>Tình trạng</span><b>{{ pledge.status || '-' }}</b></div>
      </div>
    </mat-tab>

    <!-- TAB 3 & 4: Coming soon -->
    <mat-tab label="Lịch sử đóng lãi">
      <div class="tab-content placeholder">Đang phát triển...</div>
    </mat-tab>
    <mat-tab label="Lịch sử thu phí">
      <div class="tab-content placeholder">Đang phát triển...</div>
    </mat-tab>
  </mat-tab-group>
</div>
