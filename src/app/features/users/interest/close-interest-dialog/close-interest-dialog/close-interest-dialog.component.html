<!-- src/app/features/interest/close-interest-dialog/close-interest-dialog.component.html -->
<div class="header">
  <div class="title">
    <mat-icon>request_quote</mat-icon>
    <span>Đóng lãi / Quản lý hợp đồng</span>
  </div>

  <div class="header-actions">
    <button mat-stroked-button color="primary" (click)="openSettleDialog()">
      <mat-icon>done_all</mat-icon> Tất toán
    </button>
    <button mat-stroked-button color="accent" (click)="openExtendTermDialog()">
      <mat-icon>update</mat-icon> Gia hạn kỳ
    </button>
    <button mat-stroked-button color="warn" (click)="openPartialPrincipalDialog()">
      <mat-icon>money_off</mat-icon> Trả bớt gốc
    </button>
    <button mat-stroked-button color="primary" (click)="openAdditionalLoanDialog()">
      <mat-icon>add_card</mat-icon> Vay thêm
    </button>

    <span class="spacer"></span>

    <button mat-icon-button matTooltip="Xuất PDF" (click)="exportFile('pdf')">
      <mat-icon>picture_as_pdf</mat-icon>
    </button>
    <button mat-icon-button matTooltip="Xuất Excel" (click)="exportFile('excel')">
      <mat-icon>grid_on</mat-icon>
    </button>
    <button mat-icon-button matTooltip="Đóng" (click)="close()">
      <mat-icon>close</mat-icon>
    </button>
  </div>
</div>

<mat-progress-bar *ngIf="loadingSummary" mode="indeterminate"></mat-progress-bar>

<!-- Summary cards -->
<div class="summary" *ngIf="pledge">
  <div class="card">
    <div class="label">Hợp đồng</div>
    <div class="value">{{ pledge.contractCode }}</div>
    <div class="sub">{{ pledge.customer.fullName }} ({{ pledge.customer.phoneNumber }})</div>
  </div>
<!--  <div class="card">-->
<!--    <div class="label">Gốc còn lại</div>-->
<!--    <div class="value highlight">{{ summary.remainingPrincipal | number:'1.0-0' }} đ</div>-->
<!--  </div>-->
<!--  <div class="card">-->
<!--    <div class="label">Lãi đến hôm nay</div>-->
<!--    <div class="value warn">{{ summary.interestToday | number:'1.0-0' }} đ</div>-->
<!--  </div>-->
<!--  <div class="card">-->
<!--    <div class="label">Đã thu</div>-->
<!--    <div class="value">{{ summary.totalPaid | number:'1.0-0' }} đ</div>-->
<!--  </div>-->
</div>

<!-- TAB GROUP -->
<mat-tab-group [selectedIndex]="activeTab" (selectedIndexChange)="activeTab = $event">
  <!-- TAB 1: Chi tiết đóng lãi -->
  <mat-tab label="Chi tiết đóng lãi">
    <div class="tab-toolbar">Danh sách kỳ phải đóng</div>

    <app-smart-table
      #table
      [columns]="columns"
      [fetch]="fetch"
      [actions]="rowActions"
      [pageSizeOptions]="[10,25,50,100]"
      [initialPageSize]="10"
      placeholder="Không có kỳ đóng lãi"
    >
      <!-- Templates -->
      <ng-template #sttTpl let-index="index">{{ index + 1 }}</ng-template>

      <ng-template #dateTpl let-row>
        {{ row.dueDate | date:'dd/MM/yyyy' }}
      </ng-template>

      <ng-template #lastDateTpl let-row>
        {{ row.lastPaidDate ? (row.lastPaidDate | date:'dd/MM/yyyy') : '–' }}
      </ng-template>

      <ng-template #statusTpl let-row>
        <span class="status-chip" [ngClass]="row.status === 'PAID' ? 'done' : 'pending'">
          <mat-icon *ngIf="row.status === 'PAID'">check_circle</mat-icon>
          <mat-icon *ngIf="row.status !== 'PAID'">hourglass_empty</mat-icon>
          {{ row.status === 'PAID' ? 'Đã đóng' : 'Chưa đóng' }}
        </span>
      </ng-template>
    </app-smart-table>
  </mat-tab>

  <!-- TAB 2: Thông tin hợp đồng -->
  <mat-tab label="Thông tin hợp đồng">
    <div class="tab-toolbar">Thông tin cấu hình lãi & điều khoản</div>
    <div class="contract" *ngIf="pledge">
      <div class="row"><span>Ngày vay:</span><b>{{ pledge.loan.loanDate | date:'dd/MM/yyyy' }}</b></div>
      <div class="row"><span>Mã hợp đồng:</span><b>{{ pledge.contractCode }}</b></div>
      <div class="row"><span>Người theo dõi:</span><b>{{ pledge.loan.follower || '-' }}</b></div>
      <div class="row"><span>Tình trạng:</span><b>{{ pledge.status || '-' }}</b></div>
    </div>
  </mat-tab>

  <!-- TAB 3: Lịch sử đóng lãi -->
  <mat-tab label="Lịch sử đóng lãi">
    <div class="tab-toolbar">Các lần thu lãi</div>
    <p class="placeholder">Đang phát triển...</p>
  </mat-tab>

  <!-- TAB 4: Lịch sử thu phí 1 lần -->
  <mat-tab label="Lịch sử thu phí 1 lần">
    <div class="tab-toolbar">Các khoản phí 1 lần</div>
    <p class="placeholder">Đang phát triển...</p>
  </mat-tab>
</mat-tab-group>
