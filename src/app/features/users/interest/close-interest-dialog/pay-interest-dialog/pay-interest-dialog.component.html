<div class="dialog-wrapper" [@slideIn]>
  <div class="dialog-card">

    <!-- Header -->
    <div class="dialog-header">
      <div class="header-icon">
        <mat-icon>monetization_on</mat-icon>
      </div>
      <div class="header-title">
        <h2>Đóng lãi kỳ {{ data.periodNumber }}</h2>
        <p class="subtitle">Vui lòng nhập thông tin thanh toán</p>
      </div>
    </div>

    <!-- Form -->
    <mat-dialog-content class="dialog-content">
      <form [formGroup]="form" class="form">
        <!-- 1. TỔNG LÃI KỲ -->
        <div class="info-row">
          <div class="label">Tổng lãi kỳ {{ data.periodNumber }}</div>
          <div class="value total">{{ formatMoney(data.totalAmount) }}</div>
        </div>

        <!-- 2. ĐÃ ĐÓNG (nếu có) -->
        <div class="info-row" *ngIf="data.paidSoFar > 0">
          <div class="label">Đã đóng</div>
          <div class="value paid">- {{ formatMoney(data.paidSoFar) }}</div>
        </div>

        <div class="info-row" *ngIf="data.penaltyInterest > 0">
          <div class="label text-danger">Phạt quá hạn</div>
          <div class="value text-danger font-bold">{{ formatMoney(data.penaltyInterest) }}</div>
        </div>

        <!-- 3. CÒN PHẢI ĐÓNG (NỔI BẬT) -->
        <div class="info-row required">
          <div class="label">
            <span class="text-danger" *ngIf="data.remainingAmount > 0">Còn phải đóng</span>
            <span class="text-success" *ngIf="data.remainingAmount === 0">Đã đóng đủ</span>
          </div>
          <div class="value highlight" [class.success]="data.remainingAmount === 0">
            {{ formatMoney(data.remainingAmount) }}
          </div>
        </div>
        <!-- Ngày đóng -->
        <mat-form-field appearance="outline" class="custom-field" floatLabel="always">
          <mat-label>Ngày đóng</mat-label>
          <input matInput [matDatepicker]="payDatePicker" formControlName="payDate" required>
          <mat-datepicker-toggle matIconSuffix [for]="payDatePicker">
            <mat-icon matDatepickerToggleIcon>today</mat-icon>
          </mat-datepicker-toggle>
          <mat-datepicker #payDatePicker></mat-datepicker>
          <mat-error>Vui lòng chọn ngày</mat-error>
        </mat-form-field>

        <!-- Hình thức thanh toán -->
        <mat-form-field appearance="outline" class="custom-field" floatLabel="always">
          <mat-label>Hình thức thanh toán</mat-label>
          <mat-select formControlName="paymentMethod" required panelClass="custom-select-panel">

            <!-- Các lựa chọn -->
            <mat-option *ngFor="let method of paymentMethods" [value]="method.value" class="payment-option">
              <div class="option-content">
                <mat-icon class="method-icon" [style.color]="method.color">{{ method.icon }}</mat-icon>
                <span class="method-label">{{ method.label }}</span>
              </div>
            </mat-option>

            <!-- TÙY CHỈNH HIỂN THỊ KHI ĐÃ CHỌN -->
            <mat-select-trigger>
              <div class="trigger-content" *ngIf="form.get('paymentMethod')?.value as selectedValue">
                <mat-icon class="method-icon" [style.color]="getSelectedMethod(selectedValue)?.color">
                  {{ getSelectedMethod(selectedValue)?.icon }}
                </mat-icon>
                <span class="method-label">{{ getSelectedMethod(selectedValue)?.label }}</span>
              </div>
              <span *ngIf="!form.get('paymentMethod')?.value" class="placeholder">
    Chọn hình thức
  </span>
            </mat-select-trigger>

          </mat-select>

          <mat-error>Vui lòng chọn phương thức</mat-error>
        </mat-form-field>

        <!-- Số tiền -->
        <mat-form-field appearance="outline" class="custom-field" floatLabel="always">
          <mat-label>Số tiền khách đóng</mat-label>
          <input
            matInput
            type="text"
            formControlName="amount"
            appCurrencyFormat
            [allowZero]="false"
            placeholder="0"
            required>

          <mat-error *ngIf="form.get('amount')?.hasError('required')">
            Vui lòng nhập số tiền
          </mat-error>
          <mat-error *ngIf="form.get('amount')?.hasError('min')">
            Số tiền phải lớn hơn 0
          </mat-error>
        </mat-form-field>
        <!-- SO SÁNH S� ố tiền nhập vs CÒN THIẾU -->
        <div class="info-row" *ngIf="form.value.amount">
          <div class="label">
            <span *ngIf="parseAmount() < data.remainingAmount" class="text-danger">Thiếu</span>
            <span *ngIf="parseAmount() > data.remainingAmount" class="text-warn">Dư</span>
            <span *ngIf="parseAmount() === data.remainingAmount" class="text-success">Đúng số</span>
          </div>
          <div class="value"
               [class.text-danger]="parseAmount() < data.remainingAmount"
               [class.text-warn]="parseAmount() > data.remainingAmount"
               [class.text-success]="parseAmount() === data.remainingAmount">
            {{ formatMoney(Math.abs(parseAmount() - data.remainingAmount)) }}
          </div>
        </div>
        <!-- Ghi chú -->
        <mat-form-field appearance="outline" class="custom-field" floatLabel="always">
          <mat-label>Ghi chú (không bắt buộc)</mat-label>
          <textarea matInput rows="2" formControlName="note" placeholder="VD: Chuyển khoản lúc 14:30"></textarea>
        </mat-form-field>

      </form>
    </mat-dialog-content>

    <!-- Actions -->
    <mat-dialog-actions align="end" class="dialog-actions">
      <button mat-stroked-button class="btn-cancel" mat-dialog-close>Hủy</button>
      <button
        mat-flat-button
        class="btn-confirm gradient-btn"
        [disabled]="form.invalid || isSubmitting"
        (click)="confirm()">
        <span *ngIf="!isSubmitting">Xác nhận thanh toán</span>
        <mat-spinner *ngIf="isSubmitting" diameter="20"></mat-spinner>
      </button>
    </mat-dialog-actions>

  </div>
</div>
