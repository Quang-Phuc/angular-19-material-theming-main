<h2 mat-dialog-title class="title">
  <mat-icon color="primary" class="title-icon">update</mat-icon>
  Gia hạn kỳ – Hợp đồng: <strong>{{ data.contractCode || 'CĐ251411-002' }}</strong>
</h2>

<mat-dialog-content class="content">

  <!-- 1. THÔNG TIN HỢP ĐỒNG -->
  <div class="section">
    <h3 class="section-title">
      <mat-icon class="section-icon">description</mat-icon>
      Thông tin hợp đồng
    </h3>
    <div class="grid">
      <div class="info-item">
        <span class="label">Khách hàng</span>
        <strong class="value">{{ data.detail.customerName }}</strong>
      </div>
      <div class="info-item">
        <span class="label">Số tiền vay</span>
        <strong class="value primary">{{ formatMoney(data.detail.loanAmount) }}</strong>
      </div>
      <div class="info-item">
        <span class="label">Ngày vay</span>
        <strong class="value">{{ formatDate(data.detail.loanDate) }}</strong>
      </div>
      <div class="info-item">
        <span class="label">Hạn hiện tại</span>
        <strong class="value warning">{{ formatDate(data.detail.dueDate) }}</strong>
      </div>
    </div>
  </div>

  <!-- 2. NỘI DUNG GIA HẠN -->
  <div class="section">
    <h3 class="section-title">
      <mat-icon class="section-icon">event_available</mat-icon>
      Nội dung gia hạn
    </h3>

    <form [formGroup]="form" class="form">

      <div class="form-row">
        <mat-form-field appearance="outline" class="w-50">
          <mat-label>Số kỳ gia hạn</mat-label>
          <input matInput type="number" formControlName="termNumber" min="1" required>
          <mat-hint>Ví dụ: 1 kỳ = 30 ngày</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-50">
          <mat-label>Hoặc số ngày gia hạn</mat-label>
          <input matInput type="number" formControlName="extendDays" min="1">
          <mat-hint>Ưu tiên kỳ, nếu nhập ngày sẽ dùng ngày</mat-hint>
        </mat-form-field>
      </div>

      <!-- HIỂN THỊ NGÀY MỚI -->
      <div class="new-due-date-box">
        <div class="label">Hạn mới sau gia hạn</div>
        <div class="value big success">
          <mat-icon>event</mat-icon>
          {{ formatDate(getNewDueDate()) }}
        </div>
        <small class="hint">Tăng {{ getExtendedDays() }} ngày so với hạn cũ</small>
      </div>

      <mat-form-field appearance="outline" class="full">
        <mat-label>Lý do gia hạn</mat-label>
        <textarea matInput rows="2" formControlName="reason" placeholder="VD: Khách xin gia hạn do khó khăn tài chính"></textarea>
      </mat-form-field>

      <!-- PHÍ GIA HẠN -->
      <div class="total-box" *ngIf="data.detail.extensionFee > 0">
        <div class="total-label">Phí gia hạn</div>
        <div class="total-amount text-warn">{{ formatMoney(data.detail.extensionFee) }}</div>
      </div>

    </form>
  </div>

  <!-- 3. LỊCH SỬ GIA HẠN -->
  <div class="section" *ngIf="data.detail.extensionHistory?.length">
    <h3 class="section-title">
      <mat-icon class="section-icon">history</mat-icon>
      Lịch sử gia hạn ({{ data.detail.extensionHistory.length }} lần)
    </h3>

    <table mat-table [dataSource]="data.detail.extensionHistory" class="history-table mat-elevation-z2">

      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef> Ngày </th>
        <td mat-cell *matCellDef="let h"> {{ formatDate(h.date) }} </td>
      </ng-container>

      <ng-container matColumnDef="days">
        <th mat-header-cell *matHeaderCellDef> Số ngày </th>
        <td mat-cell *matCellDef="let h"> +{{ h.days }} ngày </td>
      </ng-container>

      <ng-container matColumnDef="old">
        <th mat-header-cell *matHeaderCellDef> Hạn cũ </th>
        <td mat-cell *matCellDef="let h"> {{ formatDate(h.oldDueDate) }} </td>
      </ng-container>

      <ng-container matColumnDef="new">
        <th mat-header-cell *matHeaderCellDef> Hạn mới </th>
        <td mat-cell *matCellDef="let h">
          <strong class="text-success">{{ formatDate(h.newDueDate) }}</strong>
        </td>
      </ng-container>

      <ng-container matColumnDef="by">
        <th mat-header-cell *matHeaderCellDef> Nhân viên </th>
        <td mat-cell *matCellDef="let h"> {{ h.createdBy }} </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
  </div>

</mat-dialog-content>

<mat-dialog-actions align="end" class="actions">
  <button mat-stroked-button color="warn" mat-dialog-close>
    <mat-icon>close</mat-icon> Hủy
  </button>
  <button mat-flat-button color="primary" class="confirm-btn"
          [disabled]="form.invalid || getExtendedDays() <= 0"
          (click)="confirm()">
    <mat-icon>check_circle</mat-icon>
    Xác nhận gia hạn
  </button>
</mat-dialog-actions>
