<div class="page-container" data-aos="fade-in">
  <h1 class="page-title">Lịch sử Mua License</h1>

  <mat-toolbar class="filter-toolbar">
    <div class="search-container">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Tìm kiếm (Mã/Tên gói)</mat-label>
        <input matInput #searchInput placeholder="Nhập từ khóa..." (keyup.enter)="applyFilterFromInput(searchInput.value)">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <button mat-flat-button color="primary" class="search-button" (click)="applyFilterFromInput(searchInput.value)">
        Tìm
      </button>
    </div>
    <span class="spacer"></span>
  </mat-toolbar>

  <div class="mat-elevation-z4 table-container"> <table mat-table [dataSource]="dataSource" matSort (matSortChange)="announceSortChange($event)">

    <ng-container matColumnDef="stt">
      <th mat-header-cell *matHeaderCellDef> STT </th>
      <td mat-cell *matCellDef="let i = index">
        {{ paginator ? (paginator.pageIndex * paginator.pageSize + i + 1) : (i + 1) }}
      </td>
    </ng-container>

    <ng-container matColumnDef="packageCode">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Mã Gói </th>
      <td mat-cell *matCellDef="let row"> {{ row.packageCode }} </td>
    </ng-container>

    <ng-container matColumnDef="packageName">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Tên Gói </th>
      <td mat-cell *matCellDef="let row"> {{ row.packageName }} </td>
    </ng-container>

    <ng-container matColumnDef="purchaseDate">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Ngày Mua </th>
      <td mat-cell *matCellDef="let row"> {{ row.purchaseDate | date:'dd/MM/yyyy HH:mm' }} </td>
    </ng-container>

    <ng-container matColumnDef="amountPaid">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Số Tiền </th>
      <td mat-cell *matCellDef="let row"> {{ row.amountPaid | currency:'VND':'symbol':'1.0-0' }} </td>
    </ng-container>

    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Trạng thái </th>
      <td mat-cell *matCellDef="let row">
        <mat-chip-option [color]="getStatusColor(row.status)" selected disableRipple>
          {{ getStatusText(row.status) }}
        </mat-chip-option>
      </td>
    </ng-container>

    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef> Hành động </th>
      <td mat-cell *matCellDef="let row">
        <button mat-icon-button color="primary" matTooltip="Xem chi tiết" (click)="viewDetails(row)">
          <mat-icon>visibility</mat-icon>
        </button>
        <button mat-icon-button color="warn" matTooltip="Xóa lịch sử" (click)="deleteHistory(row)">
          <mat-icon>delete_outline</mat-icon>
        </button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

    <tr class="mat-row" *matNoDataRow>
      <td class="mat-cell" [attr.colspan]="displayedColumns.length">
        Không tìm thấy lịch sử mua nào.
      </td>
    </tr>
  </table>

    <mat-paginator #paginator
                   [length]="totalElements"
                   [pageSize]="pageSize"
                   [pageSizeOptions]="pageSizeOptions"
                   (page)="pageChanged($event)"
                   showFirstLastButtons
                   aria-label="Chọn trang">
    </mat-paginator>
  </div>

  @if (isLoading) {
    <div class="loading-shade">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
  }

</div>
