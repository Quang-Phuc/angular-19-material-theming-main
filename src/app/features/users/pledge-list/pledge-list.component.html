<div class="page-container" data-aos="fade-in">

  <div class="page-header">
    <h1 class="page-title">Hợp đồng Cầm đồ</h1>
    <div class="header-actions">
      <button mat-icon-button matTooltip="In danh sách">
        <mat-icon>print</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Xuất file">
        <mat-icon>download</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Đánh dấu">
        <mat-icon color="primary">bookmark_border</mat-icon>
      </button>
    </div>
  </div>

  <!-- THÊM MỚI: Phần chọn cửa hàng chính, tách riêng lên trên -->
  <div class="store-selector-container">
    <mat-form-field appearance="outline" class="store-select-field">
      <mat-label>Cửa hàng chính</mat-label>
      <mat-select [(ngModel)]="selectedStoreId" (selectionChange)="onStoreChange()">
        @for (store of (storeList$ | async); track store.storeId) {
          <mat-option [value]="store.storeId">{{ store.storeName }}</mat-option>
        }
      </mat-select>
    </mat-form-field>
  </div>

  <mat-toolbar class="filter-toolbar" [formGroup]="filterForm">

    <mat-form-field appearance="outline" class="filter-field search-field">
      <mat-label>Tìm kiếm</mat-label>
      <input matInput formControlName="keyword" placeholder="Tên, SĐT khách hàng...">
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Trạng Thái</mat-label>
      <mat-select formControlName="loanStatus">
        <mat-option value="dang_vay">Đang vay</mat-option>
        <mat-option value="da_dong">Đã đóng</mat-option>
        <mat-option value="tre_han">Trễ hạn</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Tình trạng</mat-label>
      <mat-select formControlName="pledgeState">
        <mat-option value="tat_ca">Tất cả</mat-option>
        <mat-option value="trong_kho">Trong kho</mat-option>
        <mat-option value="thanh_ly">Thanh lý</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Thời gian</mat-label>
      <mat-select formControlName="timeRange">
        <mat-option [value]="null">- Thời gian -</mat-option>
        <mat-option value="today">Hôm nay</mat-option>
        <mat-option value="this_week">Tuần này</mat-option>
        <mat-option value="this_month">Tháng này</mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-flat-button color="primary" class="search-button" (click)="applyFilters()">
      <mat-icon>search</mat-icon>
      <span>Tìm kiếm</span>
    </button>

    <button mat-stroked-button (click)="resetFilters()" matTooltip="Đặt lại bộ lọc">
      <mat-icon>restart_alt</mat-icon>
    </button>

    <button mat-icon-button matTooltip="Cài đặt hiển thị">
      <mat-icon>settings</mat-icon>
    </button>
  </mat-toolbar>

  <mat-toolbar class="action-toolbar">
    <button mat-flat-button class="add-new-button" (click)="openPledgeDialog()">
      <mat-icon>add</mat-icon>
      <span>Thêm mới</span>
    </button>
    <span class="spacer"></span>
    <button mat-flat-button color="warn" class="liquidation-button" (click)="openLiquidationAssets()" [matBadge]="3" matBadgePosition="after" matBadgeColor="warn">
      <mat-icon>gavel</mat-icon>
      <span>Tài sản cần thanh lý</span>
    </button>
  </mat-toolbar>

  <div class="mat-elevation-z4 table-container">

    @if (isLoading) {
      <mat-progress-bar mode="indeterminate" class="table-progress-bar"></mat-progress-bar>
    } @else {
      <div class="table-progress-bar-placeholder"></div>
    }

    <table mat-table [dataSource]="dataSource" matSort>

      <ng-container matColumnDef="stt">
        <th mat-header-cell *matHeaderCellDef> STT </th>
        <td mat-cell *matCellDef="let i = index">
          {{ paginator ? (paginator.pageIndex * paginator.pageSize + i + 1) : (i + 1) }}
        </td>
      </ng-container>

      <ng-container matColumnDef="maHopDong">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Mã hợp đồng </th>
        <td mat-cell *matCellDef="let row">
          <div class="cell-main-text">{{ row.id }}</div>
          <div class="cell-sub-text">
            {{ row.ngayVay | date:'dd/MM/yy' }} - {{ row.ngayHetHan | date:'dd/MM/yy' }}
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="tenKhachHang">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Tên khách hàng </th>
        <td mat-cell *matCellDef="let row">
          <a href="javascript:;">{{ row.customerName }}</a>
        </td>
      </ng-container>

      <ng-container matColumnDef="tsTheChap">
        <th mat-header-cell *matHeaderCellDef> TS thế chấp </th>
        <td mat-cell *matCellDef="let row"> {{ row.collateral }} </td>
      </ng-container>

      <ng-container matColumnDef="soTienVay">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Số tiền vay </th>
        <td mat-cell *matCellDef="let row">
          <div class="cell-main-text text-danger">{{ row.loanAmount | number:'1.0-0' }}</div>
          <div class="cell-sub-text">(Lãi suất: {{ row.interestRate }})</div>
        </td>
      </ng-container>

      <ng-container matColumnDef="soTienDaTra">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Số tiền đã trả </th>
        <td mat-cell *matCellDef="let row">
          <div class="cell-main-text text-success">{{ row.paid | number:'1.0-0' }}</div>
        </td>
      </ng-container>

      <ng-container matColumnDef="tienVayConLai">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Tiền vay còn lại </th>
        <td mat-cell *matCellDef="let row">
          <div class="cell-main-text">{{ row.remaining | number:'1.0-0' }}</div>
        </td>
      </ng-container>

      <ng-container matColumnDef="laiDenHomNay">
        <th mat-header-cell *matHeaderCellDef mat-sort-header> Lãi đến hôm nay </th>
        <td mat-cell *matCellDef="let row">
          <div class="cell-main-text text-danger">{{ row.interestToday | number:'1.0-0' }}</div>
          <div class="cell-sub-text">({{ row.interestPeriod }})</div>
        </td>
      </ng-container>

      <ng-container matColumnDef="trangThai">
        <th mat-header-cell *matHeaderCellDef> Trạng thái </th>
        <td mat-cell *matCellDef="let row">
          <span class="status-chip status-debt">{{ row.status }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="chucNang">
        <th mat-header-cell *matHeaderCellDef> Chức năng </th>
        <td mat-cell *matCellDef="let row" class="actions-cell">

          <button mat-icon-button matTooltip="Sửa" (click)="onEdit(row)">
            <mat-icon class="icon-edit">edit</mat-icon>
          </button>

          <button mat-icon-button [matMenuTriggerFor]="actionsMenu" matTooltip="Tùy chọn khác">
            <mat-icon>more_vert</mat-icon>
          </button>

          <mat-menu #actionsMenu="matMenu">
            <button mat-menu-item (click)="onPrint(row)">
              <mat-icon class="icon-print">print</mat-icon>
              <span>In hợp đồng</span>
            </button>
            <button mat-menu-item (click)="onShowHistory(row)">
              <mat-icon class="icon-history">history</mat-icon>
              <span>Xem lịch sử</span>
            </button>
            <button mat-menu-item (click)="onDelete(row)">
              <mat-icon class="icon-delete">delete</mat-icon>
              <span>Xóa hợp đồng</span>
            </button>


            <button mat-menu-item>
              <mat-icon>check_circle_outline</mat-icon>
              <span>Đóng hợp đồng</span>
            </button>
            <button mat-menu-item>
              <mat-icon>gavel</mat-icon>
              <span>Thanh lý</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          Không tìm thấy hợp đồng nào.
        </td>
      </tr>
    </table>

    <mat-paginator #paginator
                   [length]="totalElements"
                   [pageSizeOptions]="[10, 25, 50, 100]"
                   showFirstLastButtons
                   aria-label="Chọn trang">
    </mat-paginator>

  </div>
</div>
