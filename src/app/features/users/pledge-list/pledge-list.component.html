<!-- src/app/features/users/pledge-list/pledge-list.component.html -->
<div class="page-container">
  <div class="page-header">
    <h1 class="page-title">Hợp đồng Cầm đồ</h1>
    <div class="header-actions">
      <button mat-icon-button matTooltip="In danh sách"><mat-icon>print</mat-icon></button>
      <button mat-icon-button matTooltip="Xuất file"><mat-icon>download</mat-icon></button>
      <button mat-icon-button matTooltip="Đánh dấu"><mat-icon color="primary">bookmark_border</mat-icon></button>
    </div>
  </div>

  <!-- CHỌN CỬA HÀNG -->
  <div class="store-selector-container">
    <mat-form-field appearance="outline" class="store-select-field">
      <mat-label>Cửa hàng chính</mat-label>
      <mat-select [(ngModel)]="selectedStoreId" (selectionChange)="onStoreChange()">
        <mat-option *ngFor="let store of (storeList$ | async)" [value]="store.storeId">
          {{ store.storeName }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <!-- THANH LỌC -->
  <mat-toolbar class="filter-toolbar" [formGroup]="filterForm">
    <mat-form-field appearance="outline" class="filter-field search-field">
      <mat-label>Tìm kiếm</mat-label>
      <input matInput formControlName="keyword" placeholder="Mã HĐ, khách hàng, tài sản…">
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Trạng thái vay</mat-label>
      <mat-select formControlName="loanStatus" (selectionChange)="applyFilters()">
        <mat-option value="">Tất cả</mat-option>
        <mat-option value="NORMAL">Chưa vay</mat-option>
        <mat-option value="NORMAL_2">Đang vay</mat-option>
        <mat-option value="RISKY">Nợ rủi ro</mat-option>
        <mat-option value="BAD_DEBT_R2">Nợ R2</mat-option>
        <mat-option value="BAD_DEBT_R3">Nợ R3</mat-option>
        <mat-option value="BAD_DEBT">Nợ xấu</mat-option>
      </mat-select>
    </mat-form-field>


    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Tình trạng</mat-label>
      <mat-select formControlName="pledgeState" (selectionChange)="applyFilters()">
        <mat-option value="">Tất cả</mat-option>
        <mat-option value="DANG_VAY">Đang vay</mat-option>
        <mat-option value="QUA_HAN">Quá hạn</mat-option>
        <mat-option value="DA_TRA_HET">Đã trả hết</mat-option>
        <mat-option value="DA_DONG">Đã đóng</mat-option>
      </mat-select>
    </mat-form-field>


    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Từ ngày</mat-label>
      <input matInput [matDatepicker]="fromPicker" formControlName="fromDate" (dateChange)="applyFilters()">
      <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
      <mat-datepicker #fromPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Đến ngày</mat-label>
      <input matInput [matDatepicker]="toPicker" formControlName="toDate" (dateChange)="applyFilters()">
      <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
      <mat-datepicker #toPicker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Người Theo Dõi</mat-label>
      <mat-select formControlName="follower" (selectionChange)="onFollowerChange($event.value)">
        <mat-option value="">Tất cả</mat-option>
        <mat-option *ngFor="let n of (followerList$ | async)" [value]="n.id">
          {{ n.fullName }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-flat-button color="primary" class="search-button" (click)="applyFilters()">
      <mat-icon>search</mat-icon><span>Tìm kiếm</span>
    </button>
  </mat-toolbar>

  <!-- THANH HÀNH ĐỘNG -->
  <mat-toolbar class="action-toolbar">
    <button mat-flat-button class="add-new-button" (click)="openPledgeDialog()">
      <mat-icon>add</mat-icon><span>Thêm mới</span>
    </button>
    <span class="spacer"></span>
    <button mat-flat-button color="warn" class="liquidation-button" [matBadge]="3" matBadgePosition="after" matBadgeColor="warn">
      <mat-icon>gavel</mat-icon><span>Tài sản cần thanh lý</span>
    </button>
  </mat-toolbar>

  <!-- BẢNG -->
  <app-smart-table
    #table
    [columns]="columns"
    [fetch]="fetch"
    [actions]="rowActions"
    [pageSizeOptions]="[10,25,50,100]"
    [initialPageSize]="10"
    placeholder="Tìm kiếm hợp đồng"
  >
    <div table-actions></div>
    <ng-template #moneyTpl let-row let-col="col">
  <span class="money-cell"
        [class.text-danger]="col.key === 'remainingAmount' && row[col.key] > 0"
        [class.text-success]="col.key === 'remainingAmount' && row[col.key] === 0">
    <span class="amount">{{ formatMoney(row[col.key]) }}</span>
  </span>
    </ng-template>

  </app-smart-table>
</div>
